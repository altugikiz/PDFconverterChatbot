import gradio as gr
import google.generativeai as genai
import os
import PyPDF2
import speech_recognition as sr
from gtts import gTTS
from dotenv import load_dotenv

# Bellekte dosya iÃ§eriÄŸi ve tÃ¼rÃ¼nÃ¼ saklamak iÃ§in deÄŸiÅŸkenler
doc_memory = {"content": "", "type": ""}

def process_file(file):
    """YÃ¼klenen dosyayÄ± iÅŸler ve bellekte saklar."""
    if not file:
        return "âš ï¸ LÃ¼tfen bir dosya yÃ¼kleyin."
    
    file_extension = os.path.splitext(file.name)[1].lower()
    text = ""
    
    try:
        if file_extension == ".pdf":
            with open(file.name, "rb") as f:
                reader = PyPDF2.PdfReader(f)
                text = "\n".join([page.extract_text() for page in reader.pages if page.extract_text()])
        elif file_extension == ".txt":
            with open(file.name, "r", encoding="utf-8") as f:
                text = f.read()
        elif file_extension in [".mp3", ".wav"]:
            recognizer = sr.Recognizer()
            with sr.AudioFile(file.name) as source:
                audio = recognizer.record(source)
            text = recognizer.recognize_google(audio, language="tr-TR")
        else:
            return "âŒ Desteklenmeyen dosya tÃ¼rÃ¼. LÃ¼tfen PDF, TXT veya ses dosyasÄ± yÃ¼kleyin."
        
        if not text.strip():
            return f"âŒ {file_extension.upper()} dosyasÄ±ndan metin Ã§Ä±karÄ±lamadÄ±."
        
        doc_memory.update({"content": text, "type": file_extension[1:]})
        print("Bellekteki iÃ§erik gÃ¼ncellendi:", doc_memory["content"][:200])  # Ä°lk 200 karakteri gÃ¶ster
        return f"âœ… {file_extension.upper()} baÅŸarÄ±yla iÅŸlendi! SorularÄ±nÄ±zÄ± sorabilirsiniz."
    except Exception as e:
        return f"âŒ Dosya iÅŸlenirken hata oluÅŸtu: {str(e)}"

def text_to_speech(text):
    """Metni sese dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r."""
    try:
        tts = gTTS(text, lang="tr")
        audio_file = "output.mp3"
        tts.save(audio_file)
        return audio_file
    except Exception as e:
        return f"âŒ Ses dosyasÄ± oluÅŸturulurken hata oluÅŸtu: {str(e)}"

# .env dosyasÄ±nÄ± yÃ¼kle ve API anahtarÄ±nÄ± al
load_dotenv()
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
if not GEMINI_API_KEY:
    raise ValueError("GEMINI_API_KEY bulunamadÄ±! LÃ¼tfen .env dosyanÄ± kontrol et.")

genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel("gemini-pro")

def ask_file_question(user_input):
    """KullanÄ±cÄ±nÄ±n sorularÄ±na cevap verir. Dosya varsa dosyaya dayalÄ±, yoksa genel olarak cevap dÃ¶ndÃ¼rÃ¼r."""
    try:
        # EÄŸer dosya varsa dosya iÃ§eriÄŸine dayalÄ± bir cevap oluÅŸtur ama genel cevap da ver
        if doc_memory["content"]:
            prompt = (
                f"AÅŸaÄŸÄ±daki metinle ilgili bir soru sorulmuÅŸsa, metne dayanarak cevap ver. "
                f"EÄŸer metinle ilgili deÄŸilse, soruyu genel bilgiye dayanarak yanÄ±tla:\n\n"
                f"{doc_memory['content']}\n\nSoru: {user_input}"
            )
        else:
            prompt = user_input  # Dosya yoksa doÄŸrudan modele sor
        
        response = model.generate_content(prompt)
        
        if not response or not response.text.strip():
            return "âŒ Modelden geÃ§erli bir yanÄ±t alÄ±namadÄ±."
        
        return response.text
    except Exception as e:
        return f"âŒ Hata oluÅŸtu: {str(e)}"



# Gradio ArayÃ¼zÃ¼
with gr.Blocks() as interface:
    gr.HTML("""
        <div style='text-align: center;'>
            <h1>ğŸ“š AI Destekli Dosya Sorgulama</h1>
            <p>PDF, TXT veya ses dosyalarÄ±na dayalÄ± sorularÄ±nÄ±zÄ± sorabileceÄŸiniz yapay zeka aracÄ±.</p>
        </div>
    """)
    
    chat_history = gr.Chatbot(label="Sohbet GeÃ§miÅŸi")
    file_input = gr.File(label="ğŸ“‚ Dosya YÃ¼kle", file_types=[".pdf", ".txt", ".mp3", ".wav"])
    file_output = gr.Textbox(label="Durum", interactive=False)
    file_process_button = gr.Button("ğŸ“„ DosyayÄ± Ä°ÅŸle")
    
    user_input = gr.Textbox(label="Sorunuzu Sorun", placeholder="Dosyadaki ana tema nedir?", lines=3)
    submit_button = gr.Button("ğŸš€ GÃ¶nder")
    clear_button = gr.Button("ğŸ—‘ï¸ Sohbeti Temizle")
    
    file_process_button.click(process_file, inputs=[file_input], outputs=[file_output])
    
    def respond(message, history):
        reply = ask_file_question(message)
        print(f"Soru: {message}\nYanÄ±t: {reply}")  # Debugging iÃ§in Ã§Ä±ktÄ± al
        history.append((message, reply))
        return history, ""
    
    submit_button.click(respond, inputs=[user_input, chat_history], outputs=[chat_history, user_input])
    clear_button.click(lambda: [], outputs=[chat_history])

if __name__ == "__main__":
    interface.launch()
